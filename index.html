<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シンプルチャット</title>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            シンプルチャット
        </div>
        <div id="chat-box" class="chat-box">
            <!-- チャットメッセージがここに追加されます -->
        </div>
        <div class="chat-footer" id="chat-footer">
            <!-- ユーザーIDの設定 -->
            <div id="setup-section">
                <input type="text" id="chat-id-input" placeholder="チャットIDを入力" />
                <button onclick="joinChat()">チャットに参加</button>
                <button onclick="createChat()">チャットIDを作成</button>
                <div id="generated-chat-id" style="margin-top: 10px; font-weight: bold;"></div>
            </div>

            <!-- チャットメッセージ送信 -->
            <div id="chat-section" style="display:none;">
                <input type="text" id="user-input" placeholder="メッセージを入力..." />
                <input type="file" id="file-input" />
                <button onclick="sendMessage()">送信</button>
            </div>
        </div>
    </div>

    <script>
        let username = '';
        let chatID = '';

        // ユーザー名を入力させる
        function setUsername() {
            username = prompt("ユーザー名を入力してください:", "ユーザー");
            if (!username || username.trim() === '') {
                username = "匿名ユーザー";
            }
            localStorage.setItem('currentUser', username);
        }

        // チャットIDを作成する関数
        function createChat() {
            chatID = generateChatID();
            localStorage.setItem('chatID', chatID);
            document.getElementById('generated-chat-id').textContent = `生成されたチャットID: ${chatID}`;
            alert(`チャットIDが作成されました: ${chatID}`);
        }

        // チャットに参加する関数
        function joinChat() {
            const inputChatID = document.getElementById('chat-id-input').value.trim();
            const storedChatID = localStorage.getItem('chatID');

            if (inputChatID === storedChatID) {
                chatID = inputChatID;
                localStorage.setItem('currentChatID', chatID);
                document.getElementById('setup-section').style.display = 'none';
                document.getElementById('chat-section').style.display = 'flex';
                setUsername();
                loadMessages();
            } else {
                alert('無効なチャットIDです。');
            }
        }

        // チャットIDを生成する関数
        function generateChatID() {
            return Math.random().toString(36).substring(2, 8);
        }

        // ページが読み込まれたらユーザー名とチャットIDを設定
        window.onload = function() {
            // すでにアクセスしたユーザー名とチャットIDを取得
            username = localStorage.getItem('currentUser') || '';
            chatID = localStorage.getItem('currentChatID') || '';

            if (!username) {
                setUsername();
            }
            if (chatID) {
                document.getElementById('setup-section').style.display = 'none';
                document.getElementById('chat-section').style.display = 'flex';
                loadMessages();
            }
        };

        // メッセージを送信する関数
        function sendMessage() {
            const userInput = document.getElementById('user-input');
            const fileInput = document.getElementById('file-input');
            const message = userInput.value.trim();
            const file = fileInput.files[0];

            if (message === '' && !file) return;

            const chatBox = document.getElementById('chat-box');

            // ユーザーのメッセージを追加
            if (message !== '') {
                const userMessage = document.createElement('div');
                userMessage.classList.add('chat-message', 'user');
                userMessage.innerHTML = `<span class="username">${username}</span>${message}`;
                chatBox.appendChild(userMessage);
                saveMessage(username, message, 'text');
            }

            // 画像や音声、動画を送信する場合
            if (file) {
                const fileURL = URL.createObjectURL(file);
                const fileMessage = document.createElement('div');
                fileMessage.classList.add('chat-message', 'user');
                fileMessage.innerHTML = `<span class="username">${username}</span>`;

                // ファイルタイプに応じた処理
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = fileURL;
                    fileMessage.appendChild(img);
                    saveMessage(username, fileURL, 'image');
                } else if (file.type.startsWith('audio/')) {
                    const audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = fileURL;
                    fileMessage.appendChild(audio);
                    saveMessage(username, fileURL, 'audio');
                } else if (file.type.startsWith('video/')) {
                    const video = document.createElement('video');
                    video.controls = true;
                    video.src = fileURL;
                    fileMessage.appendChild(video);
                    saveMessage(username, fileURL, 'video');
                } else {
                    fileMessage.textContent += `ファイルを送信: ${file.name}`;
                    saveMessage(username, `ファイルを送信: ${file.name}`, 'file');
                }
                chatBox.appendChild(fileMessage);
            }

            // 入力フィールドをクリア
            userInput.value = '';
            fileInput.value = '';

            // チャットボックスをスクロール
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // メッセージを保存する関数
        function saveMessage(username, content, type) {
            const messages = JSON.parse(localStorage.getItem('messages')) || [];
            messages.push({ chatID, username, content, type });
            localStorage.setItem('messages', JSON.stringify(messages));
        }

        // メッセージを読み込む関数
        function loadMessages() {
            const messages = JSON.parse(localStorage.getItem('messages')) || [];
            const chatBox = document.getElementById('chat-box');

            messages.forEach(message => {
                if (message.chatID === chatID) {
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('chat-message', message.username === username ? 'user' : 'other-user');
                    messageElement.innerHTML = `<span class="username">${message.username}</span>`;
                    
                    if (message.type === 'text') {
                        messageElement.innerHTML += message.content;
                    } else if (message.type === 'image') {
                        const img = document.createElement('img');
                        img.src = message.content;
                        messageElement.appendChild(img);
                    } else if (message.type === 'audio') {
                        const audio = document.createElement('audio');
                        audio.controls = true;
                        audio.src = message.content;
                        messageElement.appendChild(audio);
                    } else if (message.type === 'video') {
                        const video = document.createElement('video');
                        video.controls = true;
                        video.src = message.content;
                        messageElement.appendChild(video);
                    } else {
                        messageElement.textContent += message.content;
                    }
                    chatBox.appendChild(messageElement);
                }
            });

            // チャットボックスをスクロール
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
</body>
</html>
